---
title: "Land Productivity Dynamics Indicator: LPDynR package"
subtitle: ""

author:
  - Xavier Rotllan-Puig:
      email: xavi.rotllan.puig@gmail.com
      institute: [jrc, aster]
      correspondence: true
  - Eva Ivits:
      institute: [eea]
  - Pier Lorenzo Marasco:
      institute: [jrc]
  - Federico Gianoli:
      institute: [jrc]
  - Michael Cherlet:
      institute: [jrc]
 
institute:
  - jrc: Joint Research Centre – European Commission. Directorate D – Sustainable Resources. Unit D6 – Knowledge for Sustainable Development & Food Security Unit. Via Enrico Fermi 2749. I-21027 Ispra (VA), ITALY
  - aster: ASTER-Projects. Barri Reboll, 9, 1r. 08694 Guardiola de Berguedà (Barcelona), SPAIN
  - eea: Geospatial Information Services group, European Environment Agency, Copenhagen, DENMARK


date: "`r format(Sys.time(), '%d/%m/%Y')`"

output: 
  word_document:
    reference_docx: LPD_MS_styles.docx
    #toc: true #table of content true
    toc_depth: 3  #up to three depths of headings (specified by #, ## and ###)
    #number_sections: true  #number sections at each table header
    #theme: united  #options for theme
    #highlight: tango  #syntax highlighting style
    #css: style.css   #custom css, should be in same folder. Only for HTML
    pandoc_args:
      - --lua-filter=scholar-metadata.lua
      - --lua-filter=author-info-blocks.lua
      
bibliography: lpd_biblio.bib
#csl: methods-in-ecology-and-evolution.csl
always_allow_html: yes

#abstract: |
#  **Introduction**: bla bla
#  **Material & Methods**: ble ble
#  **Results**: bli bli
#  **Discussion**: blo blo
#  **Conclusion**: blu blu
  

---


```{r setup, include = FALSE, results='asis'}
library(knitr)
library(pander)
library(captioner)
knitr::opts_chunk$set(echo = TRUE)

```

```{r include = FALSE}
#if(Sys.info()[4] == "D01RI1700371"){
#  source("E:\\rotllxa\\LPD\\LPD/00_settings.R")
#}else if(Sys.info()[4] == "h05-wad.ies.jrc.it"){
#  source("/home/rotllxa/LPD/LPD/00_settings.R")
#}else if(Sys.info()[4] == "MacBook-MacBook-Pro-de-Xavier.local"){
#  source("/Users/xavi_rp/Documents/D6_LPD/LPD/00_settings.R")
#}
path2tempResults <- "/Users/xavi_rp/Documents/D6_LPD/LPD_MODIS_Europe"
path2saveTests <- path2tempResults

table_num <- captioner::captioner(prefix = "Table")
fig_num <- captioner::captioner(prefix = "Figure")
#ts <- 0
```





**Abstract**

As part of the UN Sustainable Development Goal 15 (Life on Land), the indicator 15.3.1 is adopted to measure the Land Degradation Neutrality (stable —or increasing— state regarding the amount and quality of land resources required to support ecosystem functions and services and enhance food security during a certain period of time). It is a binary indicator (i.e. degraded/not degraded), expressed as the proportion (%) of land that is degraded over total land area, and is based on three sub-indicators: (1) Trends in Land Cover, (2) Land Productivity and (3) Carbon Stocks. 

The Land Productivity sub-indicator (LP) refers to the total above-ground Net Primary Production and reflects changes in health and productive capacity of the land. Its declining trends can be usually understood as land degradation. LP is calculated using the Land Productivity Dynamics (LPD) approach, first developed by Ivits and Cherlet [-@Ivits_report_2013]. 

The LPD is the methodological basis of the *LPDynR* package. It uses phenological and productivity variables derived from time series of remote sensed imagery, particularly the normalized difference vegetation index (NDVI), to estimate ecosystem dynamics and change. The final result of the LPD indicator is a categorical map with 5 classes of land productivity dynamics, ranging from declining to increasing productivity.

As an example of *LPDynR* usage...



# Introduction

```{r echo=FALSE}

```

The United Nations General Assembly designed in 2015 a collection of 17 global goals, so called Sustainable Development Goals [SDGs; @UN_SDGs_2015], with the general aim of "achieving a better and more sustainable future for all", and which were intended to be accomplished by the year 2030. Each SDG is subdivided into a list of targets which, in turn, go together with indicators to be able to measure their success. Such indicators have to be credible, based on standardized methodologies and, often, spatially explicit [@dubovyk_2017]. The SDG-15 entitled Life on Land has among its targets the 15.3, which expects "to combat desertification, restore degraded land and soil, including land affected by desertification, drought and floods, and strive to achieve a land degradation-neutral world". In this context, Land Degradation Neutrality (LDN) is defined as the stable (or increasing) state regarding the amount and quality of land resources required to support ecosystem functions and services and enhance food security during a certain period of time [@LDN_2015].

The indicator 15.3.1 is adopted to measure the LDN, and it is expressed as the proportion (%) of land that is degraded over total land area. It is a binary indicator (i.e. degraded/not degraded) based on three sub-indicators: (1) Trends in Land Cover, (2) Land Productivity and (3) Carbon Stocks. While the first two can capture relatively fast changes, carbon stocks reflect slower changes which suggest a longer term trajectory. These three sub-indicators must be comparable among territories and based on standardized sources and methods. The data can be collected through existing sources, such as maps, reports or databases, but also can be derived from Earth Observation (EO) imagery using remote sensing tools. 

The Land Productivity sub-indicator (LP), addressed in this document, refers to the total above-ground net primary production (NPP), which can be defined as the total energy fixed by plants minus their respiration. Such energy is transformed into biomass which, in turn, allows ecosystems to develop their functions and deliver essential services. Therefore, LP reflects changes in health and productive capacity of the land and its declining trends can be usually understood as land degradation [@WAD_2018; @Prince_2009; @Yengoh_2015]. It is calculated using the Land Productivity Dynamics (LPD) approach, first developed by Ivits and Cherlet [-@Ivits_report_2013], which is the methodological basis of the *LPDynR* tool presented in this document. 


# Land Productivity Dynamics and *LPDynR*

```{r echo=FALSE}
fig0 <- fig_num(name = "f0", caption = "Flowchart of the process to calculate the Land Productivity Dynamics indicator and followed by *LPDynR*")
grph02 <- paste0("/Users/xavi_rp/Documents/D6_LPD/LPDynR/doc", "/graph02.png")

#tb1 <- table_num(name = "t1", caption = "bla bla bla")

```


The Land Productivity Dynamics (LPD) approach is based fundamentally on the use of time series of vegetation-related indices derived from remote sensed imagery, such as the normalized difference vegetation index (NDVI). NDVI, for example, can be used as a proxy for land productivity, as many studies at global and local scales have identified a strong relationship between NDVI and NPP [@Ivits_report_2013; @Prince_2009; @Yengoh_2015, and references therein]. The LPD approach often uses phenological and productivity-related variables derived from time series of NDVI, given that these can provide additional information on several aspects of vegetation/land cover functional composition in relation to ecosystem dynamics and change [@ivits_ecosystem_2013]. These dynamics of the ecosystems, which eventually might drive to land degradation, can be caused by human activities and/or biophysical processes, as well as other processes not tied to them, such as climate change [@Yengoh_2015]. While the most commonly used phenological parameters are the beginning and the end date of the vegetation growing season, together with the season length in number of days, the ones related to land productivity are those which approximates the measures to NPP and growing season production.    

The final result of the LPD indicator is a categorical map with 5 classes of land productivity dynamics, ranging from declining to increasing productivity. It is the result of a combined assessment of two sources of information, as seen in `r fig_num("f0", display = "cite")`. On the one hand, the first layer is the Long Term Change Map. In general terms, it shows the tendency of change of land productivity (positive or negative) and the effect that this tendency might have had on a particular original point after a certain period of time. On the other hand, the second layer is the Current Status Map, which provides information on the current levels of land productivity in relation to its potential by comparing the local productivity with the range of productivity across similar areas in terms of land cover or bioclimatic traits [@sims_2017]. Further explanations for both branches will be given in their own sections below. 


![`r fig0`](`r grph02`)
&nbsp;


Following the LPD approach, *LPDynR* is an R-based tool (i.e. an R package) which allows the user to produce the final Land Productivity Dynamics Map using as inputs a set of time series of phenological and/or productivity variables (multi-band GeoTIFF rasters). By means of the different functions included in the package, it produces intermediate layers (e.g. Steadiness Index, Ecosystem Functional Types, etc.) which are used to calculate both the Long Term Change Map and the Current Status Map. In addition, several parameters can be set along the process in order to fit them with the preferences of the user. The functions included in the package have no limitations regarding the number of years included in the time series, the variables to use or the spatial extent and resolution. The source code of the latest version of *LPDynR* can be found at https://github.com/xavi-rp/LPDynR.




```{r echo=FALSE}
## Phenolo
#Should this part be removed?? I think *Phenolo* should have its own document.
#But if not, I keep it here for Lorenzo to fill it (???).
```




# Data set preparation

A case study is presented in this document in order to illustrate the methodology implemented in the *LPDynR* package to calculate the LPD indicator. In this case, it is used a data set of 3 phenological and productivity-related variables, at European level and 0.5km of spatial resolution, produced and freely distributed by the European Environmental Agenct - Europeam Commission (https://www.eea.europa.eu/data-and-maps/). They are all derived from time series (2000-2016) of MODIS imagery and its derived product Plant Phenology Index [PPI; @JIN2014512]. PPI is linearly related to the canopy green leaf area index (LAI) and has a temporal pattern very similar to the one shown by the gross primary productivity (GPP) estimated by flux towers at ground reference stations. The three variables are produced using the software TIMESAT [@timesat_2004]. More information about them can be found in their own webpage:

- Above ground vegetation productivity (from now on, CF): https://www.eea.europa.eu/data-and-maps/data/annual-above-ground-vegetation-productivity

- Start of vegetation growing season (from now on, SBD): https://www.eea.europa.eu/data-and-maps/data/annual-start-of-vegetation-growing)

- Vegetation growing season length (from now on, SL): https://www.eea.europa.eu/data-and-maps/data/annual-above-ground-vegetation-season)


In the *LPDynR* v.1.0.0 the main function uses multi-band "GeoTIFF" rasters to start the process, one per phenological/productivity variable. Each band of each raster contains one of the years of the time series. Therefore, the initial data set needs to be prepared accordingly.

In addition, *LPDynR* comes with a small data set, which can be used to run tests, as well as some examples in the form of "vignettes" attached to the package. Once the package is installed, a basic example can be seen loading the following lines of R code:

```r
# To install the latest version of LPDynR
library(devtools)
install_github("xavi-rp/LPDynR")

# Launching an example
library(LPDynR)
vignette(topic = "LPD_simple_example", package = "LPDynR")

```
&nbsp;




# Long Term Change Map of Land Productivity

As seen in `r fig_num("f0", display = "cite")` and explained above, the Land Productivity Dynamics indicator is produced based in two different main layers, being the first one the Long Term Change Map (also called “tendency map”). In turn, this tendency incorporates information both on the progression of the general process of land dynamics (positive or negative) and on the original level of productivity of the ecosystem, as well as whether it has changed its state or not in the period of study [@Ivits_report_2013]. The multi-source information used for the Long Term Change Map derivation is necessary because, for instance, even though an ecosystem presents a long term negative dynamics, it might have not been strong enough to decrease its level of productivity to change its original state. The way in which the three sources of information are calculated for the Long Term Change Map using a land productivity variable is described in the following subsections.


## Steadiness Index

```{r echo=FALSE}

fig1 <- fig_num(name = "f1", caption = "Representation of the Steadiness Index for the case study based on the 'Above ground vegetation productivity' variable")
slp_rstr <- paste0(path2saveTests, "/SteadInd.jpg")

tabSteadInd <- table_num(name = "tabSteadIndex", caption = "Description of the four Steadiness Index classes and how they are derived based on the combination of the signs of both the slope of the linear function and the net change")
SteadInd <- as.data.frame(matrix(nrow = 4, ncol = 4,
                                 c("Steadiness1", "Steadiness2", "Steadiness3", "Steadiness4", "-", "-", "+", "+", "-", "+", "-", "+", "Strong negative ecosyst. dynamics (possibility changing equil.)", "Moderate negative ecosyst. dynamics (likely remain current equil.)", "Moderate positive ecosyst. dynamics (likely remain current equil.)", "Strong positive ecosyst. dynamics (possibility changing equil.)")))
names(SteadInd) <- c("Steadiness Class", "Slope", "Net Change", "Description")

```

The first of the three metrics which integrates the Long Term Change Map represents the long term tendency of degradation of the natural systems on study, either positive or negative. This metrics is the "Steadiness Index" which, in turn, is based on the combination of two other metrics calculated per pixel: (1) the slope derived from a linear regression of the different years of the time series and (2) the net change of the productivity level on the same period.

The use of a linear regression would imply to respect some strict statistical assumptions for confidence intervals and significance tests to be representative. This is why the Steadiness Index only keeps classes of tendency and no more tests are run for assessing its significance. See Ivits and Cherlet [-@Ivits_report_2013] for further explanations on this point. Therefore, only the sign (positive or negative) of the slope of the trend is kept as the value of each pixel's tendency of ecosystem dynamics. In addition, the net change of the productivity variable is calculated for the same time window and per pixel using the Multi-Temporal Image Differencing method [MTID; @Guo_2008]. And, afterwards, it is transformed also into positive or negative net change. Finally, both metrics (slope of the linear function and net change category) are combined to get four "steadiness" categories as seen in `r table_num("tabSteadIndex", display = "cite")`.

`r table_num("tabSteadIndex", display = "full")`
```{r echo = FALSE}
pander(SteadInd)

```
&nbsp;


While `r fig_num("f1", display = "cite")` represents a 4-class map of the Steadiness Index for the case study, the following lines of code show how to run the function *steadiness()* of the package to calculate the Steadiness Index.

```r
?steadiness
SteadInd <- steadiness(obj2process = cf,  # 'cf' is the productivity variable with the time series 
                       cores2use = 3,     # for parallel processing
                       filename = "SteadInd.tif")
```
&nbsp;

![`r fig1`](`r slp_rstr`)



## Baseline levels of the productivity variable

```{r echo=FALSE}
figBasline <- fig_num(name = "figBasLev", caption = "Representation of the baseline levels of land productivity for the case study")
bsl_lev <- paste0(path2saveTests, "/Baseline.jpg")

```

The second source of information for the derivation of the Long Term Change Map is the baseline levels of the productivity variable in study, in the example case, the "Above ground vegetation productivity" variable. 

For the calculation of the baseline levels of land productivity at the beginning of the time series on study, *LPDynR* categorizes the results into three classes: low, medium and high. To do that, the function *baseline_lev()* averages the first *n* years of the time series in order to avoid extreme events such as abnormal droughts in wet areas, etc. This number of years can be set by passing the argument *yearsBaseline* to the function. Its default is 3, given that averaging more years would move the value closer to the mean of the time series, which is not desirable.

After the average is calculated, *baseline_lev()* first classifies pixels into 10 classes instead of the final three (i.e. low, medium and high) using 10-quantiles. The reason for this intermediate step is that, if directly opted for three classes, the number of pixels per category would have been classified homogeneously (i.e. 33.3% of pixels/class), and this is in contrast with what is stated by the United Nations Development Programme (https://www.undp.org). UNPD declares that 40% of the World's land resources are drylands [@UNDP_drylands_2011] and, therefore, 40% of pixels at global level must be classified as "low level" of productivity. Consequently, as default, *LPDynR* classifies the first four groups of pixels as "low", whereas the five consecutive groups as "medium" and the rest 10% of pixels with the largest baseline levels, as "high". Both the proportion of pixels classified as low level and high level of land productivity can be set by passing to *baseline_lev()* the arguments *drylandProp* and *highprodProp*, respectively. The function classifies the rest of the pixels ((100 - (*drylandProp* + *highprodProp*)) as medium level. The assumption of classifying 40% of pixels as low productive is valid at global level, however, the proportion of drylands/low level of productivity should be modified for local studies. For example, at the European level, drylands cover 20% of total land [@FAO_2019].

In the following lines of code it can be observed how to run *baseline_lev()* to categorize the baseline levels of productivity, while adjusting the parameters to the European proportion of drylands. The result is a final 3-class map showing the estimation of the levels of productivity at the beginning of the time series (`r fig_num("figBasLev", display = "cite")`).

```r
?baseline_lev

Baseline_Level <- baseline_lev(obj2process = cf, 
                               yearsBaseline = 3, 
                               drylandProp = 0.2,  # 20% as dryland
                               highprodProp = 0.1, # 10% highly productive land 
                               cores2use = 3, 
                               filename = "Baseline_Level.tif")
```
&nbsp;

![`r figBasline`](`r bsl_lev`)




## State Change of the productivity variable

```{r echo=FALSE}
figStateCh <- fig_num(name = "figStateChange", caption = "Representation of the state change map of Standing Biomass (baseline levels minus final levels), after being reclassified into 3 categories (1: no change; 2: changed 1 class; 3: changed 2 or more classes) for the case study. Also the proportion of pixels/group")
state_change <- paste0(path2saveTests, "/SeasInt_Change.jpg")

```

The third layer used for the Land Productivity Long Term Change Map is the change of the state of the productivity variable during the time window of the study. This point is necessary for land degradation assessments as it reports whether productivity thresholds have been passed or not. The state change can be a consequence of either that natural resilience thresholds have been surpassed or new land use/practices have been introduced by humans [@Ivits_report_2013].

To calculate this state change per pixel, *LPDynR* uses both the state level at the beginning of the time series, as calculated in the previous subsection, and the state level at the end of the period. This final state is calculated in the same way than the base line level, i.e. (1) averaging the last 3 years and (2) classifying into 10 categories using 10-quantiles. The reason for not using the final 3-class classification is because it would be difficult to appreciate if the change of one state to another was due to a big or a small change. Instead, using the 10-class classification, one can see for instance if a pixel has moved from class 5 to 4 (small change) or from class 9 to 4 (big change).

Once the class change per pixel has been calculated, either with positive or negative results, the map is categorized into 3 final classes: (1) no change, (2) changed 1 class or (3) changed 2 or more classes. See `r fig_num("figStateChange", display = "cite")` for a map of the state change in the case study. The following code shows how to run the function *state_change* to perform the final classification:

```r
?state_change
State_Change <- state_change(obj2process = sb, 
                             yearsBaseline = 3, 
                             cores2use = 3,
                             filename = "State_Change.tif")
```
&nbsp;

![`r figStateCh`](`r state_change`)



## Land Productivity Long Term Change Map

```{r echo=FALSE}
figLongTerm_change <- fig_num(name = "figLngTrm_change", caption = "Land Productivity Long Term Change Map for the case study, based on the combination of Steadiness Index, base line levels and state change of standing biomass. **I know that the colour palette is not 'colour-blind friendly', but it's hard to find such a palette with so many colours... any suggestion very welcome!!**")
LongTerm_change <- paste0(path2saveTests, "/LandProd_change.jpg")


tb_LongTerm <- table_num(name = "tb_LngTrm", caption = "Lookup table for the Land Productivity Long Term Change Map (Steadiness Index + Base Line Levels + State Change)")
LookUpLongTerm <- as.data.frame(matrix(nrow = 3, ncol = 14,
                                       
                                       c("No Change", "Changed 1 class", "Changed ≥ 2 classes", rep(" ", 3),
                                         1:9, rep(10, 3), rep(11, 3), rep(12, 3),
                                         rep(13, 3), rep(14, 3), rep(15, 3), 16:21,
                                         rep(22, 3))
                                       ))
LookUpLongTerm <- rbind(t(as.data.frame(c("Class Change", "Stead.Ind./BaseL.", paste0(c(rep("St1", 3), rep("St2", 3),
                                                                   rep("St3", 3), rep("St4", 3)),
                                                                 c(" low", " med.", " high"))))), 
                        LookUpLongTerm)

#LookUpLongTerm <- rbind(t(as.data.frame(c(rep(" ", 6), "Stead.Ind./BaseL.", #rep(" ", 6)))), LookUpLongTerm)

rownames(LookUpLongTerm) <- NULL
colnames(LookUpLongTerm) <- NULL

num_cats <- max(as.numeric(as.character(unlist(LookUpLongTerm[-1, 3:14]))))

```

The Land Productivity Long Term Change Map is one of the two pillars of the LPD indicator (`r fig_num("f0", display = "cite")`) calculated with *LPDynR*. As seen in the previous subsections, the Long Term Change Map is developed, in turn, by the combination of the Steadiness Index, the base line levels and the state change of the productivity variable in use. The Standing Biomass derived with *Phenolo* is the variable used in the case study presented in this document. 

The function *LongTermChange* (see an example of running it below) performs the combination of the three qualitative metrics into the Long Term Change Map, resulting in `r num_cats` new categories as shown in `r table_num("tb_LngTrm", display = "cite")`. The final map of the case study is presented in `r fig_num("figLngTrm_change", display = "cite")`.

```r
?LongTermChange
Long_Term_Change_Map <- LongTermChange(SteadinessIndex = SteadInd, 
                                       BaselineLevels = Baseline_Level,
                                       StateChange = State_Change, 
                                       filename = "Long_Term_Change_Map.tif")
```

&nbsp;


`r table_num("tb_LngTrm", display = "full")`
```{r echo = FALSE}
LookUpLongTerm <- t(LookUpLongTerm)
emphasize.strong.cols(1)
#emphasize.strong.rows(1)
pander(LookUpLongTerm)
```

&nbsp;


![`r figLongTerm_change`](`r LongTerm_change`)

&nbsp;



At this point, the user might want to finalise the LPD calculation avoiding the second part of the methodology proposed by Ivits and Cherlet [-@Ivits_report_2013], which is the Current Status Map of Land Productivity. In this case, the function *LPD_CombAssess* (see further explanations in its subsection below) can be called to reclassify the `r num_cats`-class Long Term Change Map into the final 5 classes of LPD. In the following code it can be seen an example of how to run the function to perform the reclassification.

```r
?LPD_CombAssess
LPD_finalMap <- LPD_CombAssess(LandProd_change = "Long_Term_Change_Map", 
                               LandProd_current =  NULL,
                               filename = "LPD_finalMap.tif")
plot(LPD_finalMap)
```

&nbsp;



# Current Status Map of Land Productivity

The Land Productivity Dynamics indicator is composed by two base layers, as shown in `r fig_num("f0", display = "cite")`. After the long term productivity dynamics described previously (i.e. Long Term Change Map), the second source of information needed is the current level of land productivity. For this purpose, a Local Net Scaling approach is implemented [@Prince_2009]. Such approach estimates, by means of Earth Observation imagery and remote sensing tools, the level of land productivity of each pixel relative to its neighbours with similar characteristics. In other words, it calculates the potential level of productivity of each pixel within a homogeneous land unit at the time under study. The Current Status Map may help, for instance, to identify areas which, although having a positive trend of productivity over time, their levels of current productivity are low relative to the pixels in the same homogeneous land unit and, thus, they might be still suffering land degradation [@sims_2017]. A first step for the calculation of the Current Status Map, therefore, must be the derivation of the homogeneous land units across the area of study. 


## Ecosystem Functional Types (EFTs)
```{r echo=FALSE}
figMulticoll <- fig_num(name = "Multicoll", caption = "Dendrogram of groups of correlated variables. Multicollinearity cutoff set to r > |0.7|. sbd: Season Beginning Day; sed: Season End Day; sl: Season Length; si: Season Integral; mi: Standing Biomass")
Multicoll_plot <- paste0(path2tempResults, "/vars_collinearity.jpg")

figScreePlot <- fig_num(name = "ScreePlot", caption = "“Scree plot” method used to calculate the optimal number of clusters. The “elbow” indicates where the quality of the model no longer improves substantially as the number of clusters (model complexity) increases")
ScreePlot_plot <- paste0(path2tempResults, "/optim_num_clusters.jpg")

figEFTs <- fig_num(name = "EFTs", caption = "Ecosystem Functional Types (EFTs) derived from phenological and productivity variables using the K-means clustering method")
EFTmap <- paste0(path2saveTests, "/clusters_EFTs.jpg")
```

The methodology implemented in *LPDynR* to derive homogeneous land units, named Ecosystem Functional Types (EFTs), is adapted from Ivits, Cherlet, Horion et al. [-@ivits_global_2013]. It is basically a clustering process which uses, in this case, phenological and productivity variables to create the groups. Among the different unsupervised clustering techniques available for data grouping, K-means has been chosen. K-means is widely used in data science mainly due to its relative simplicity. 

Originally, the unsupervised classification was performed after a three-steps preprocessing of the variables: (1) removing highly correlated variables; (2) a first Principal Component Analysis to know the optimal number of PCs and their associated variables showing the highest loadings; and (3) a final PCA to clearly associate each PC with one variable. However, some recent tests have shown that the final LPD indicator does not differ significantly when it is derived using the raw phenological/productivity variables. Therefore, although the two-PCAs step is also implemented in *LPDynR*, only removing those highly correlated variables (e.g. |r| > 0.7) is recommended before to run the k-means clustering.

In order to check for multicollinearity among the variables, the function *rm_multicol()* first calculates their averages among the years of the time series. Then, the process is run using the function *removeCollinearity()* from the package *virtualspecies*. This function allows the user to set up the minimum Pearson's correlation absolute value, which is established to be 0.7 as default. It is also allowed to use a subset of random points of the data set to calculate the correlation in case the rasters have a large number of pixels and the user wants to speed up the process. The default number of random points selected is 10% of total pixels in the raster. Finally, one of the variables of each group of correlation is randomly select. A dendrogram to visualize the groups of intercorrelated variables can be plotted. `r fig_num("Multicoll", display = "cite")` shows a dendrogram for the present case study, which has been run with three variables. In the following piece of code it can be seen an example of how to run *rm_multicol()* with all the parameters mentioned.

```r
?rm_multicol

variables_noCor <- rm_multicol(dir2process = variables_dir,    
                               multicol_cutoff = 0.7, 
                               cores2use = 3,
                               filename = "variables_noCor.tif",
                               # The following arguments are passed to virtualspecies:removeCollinearity()
                               sample.points <- TRUE  # using 'nb.points' (or 10% of pixels) to calculate multicollinearity
                               nb.points <- 1000000   
                               plot <- FALSE  # if TRUE it writes out a dendrogram
                               )

```
&nbsp;


![`r figMulticoll`](`r Multicoll_plot`)
&nbsp;


In case the user would like to run the two-PCAs step, both the first "screening PCA", which is done over the uncorrelated variables, and the "final PCA" are subsequently performed with the same function *PCAs4clust()*. In order to know the optimal number of variables to be used in the "final PCA", a threshold of cumulative variance of the PCs is implemented. This threshold is established to be 0.9 as default. The following code shows an example of how to run this process.

```r
?PCAs4clust

pca_final_brick <- PCAs4clust(obj2process = variables_noCor, 
                              cumul_var_threshold = 0.9,
                              filename = "pca_final_brick.tif")
```
&nbsp;


Finally, the clustering algorithm can be run over either the selected PCs or the uncorrelated raw variables using the function *EFT_clust()*. This function uses *kmeans()* from the package *stats*. K-means is an iterative unsupervised method which has as one of the main limitations the fact that it is not able to optimize the number of clusters by itself. Instead, it needs to be done externally. In this case, the optimal number of clusters can be determined using the “scree-plot method". Such method is implemented in *LPDynR* with the function *clust_optim()* and it is based on running several K-means clustering with different number of clusters each, in order to assess how the quality of the models change with the number of clusters. Then, a plot is produced with the results and an “elbow” indicates where the quality of the model no longer improves substantially as the number of clusters (model complexity) increases. See `r fig_num("ScreePlot", display = "cite")` for the results of the example presented in this document and the following code as an example of how to call the function. Notice that the clustering has been run with nine different number of clusters to give a good amount of points to plot the curve. And also that the maximum number of iterations is set up to 10. Although it is unlikely that the process gets any convergence with such a low number of iterations, the results are already valid for the purpose.

```r
?clust_optim

jpeg("OptimalNumClusters.jpg")
clust_optim(obj2clust = pca_final_brick, 
            num_clstrs = seq(5, 50, 5)
            )
dev.off()

```
&nbsp;


![`r figScreePlot`](`r ScreePlot_plot`)
&nbsp;

The “scree plot” method, undoubtedly has some level of subjectivity, as the user decides where the curve flattens enough. Alternatively, to remove such subjectivity, several numerical methods exist to calculate the optimal number of clusters, although they take also some statistical assumptions. These methods could be explored in the future if a higher level of accuracy is believed as necessary or if the whole process wants to be done without user's intervention. In addition, other hierarchical clustering methods could be explored in order to avoid calculating the optimal number of clusters beforehand, although previous tests run with ISODATA have been shown to be highly resource demanding, especially in terms of computing time.

Once the optimal number of clusters are estimated, the final clustering is run with the function *EFT_clust()*. It is important to notice that when setting *nstart*, the larger, the more accurate result. This is because the function uses different sets of starting random centroids and runs the clustering *nstart* times, and the best result is chosen. Therefore, a larger *nstart* increases the chances of having a better cluster classification. *EFT_clust()* provides, together with a RasterLayer object with the clusters, a clustering performance evaluator. This value is calculated by the ratio of *betweenss* (i.e. between-cluster sum of squares) and *totss* (i.e. total sum of squares), in percentage, and it is expected to be as higher as possible.

In addition, *k-means()* can use different algorithms to perform the clustering (e.g. "MacQueen", "Hartigan-Wong", etc.). As stated in the function documentation (*?k-means*), "Hartigan-Wong" usually gives better results, although it is recommended to try several starts (*nstart > 1*). However, when using "Hartigan-Wong" with a (too) large number of clusters and a lot of values of the variables are very similar, *k-means()* is not able to converge in an acceptable amount of time (even increasing the number of iterations). In these cases, the user has to be careful because *k-means()* only gives a warning, so the final clustering is based on a non converged process. Diminishing the number of clusters or rounding variables' values might be good strategies to help *k-means()* to converge.

Finally, as previous tests of K-means with up to 100 iterations were not converging, the maximum number of iterations is set to 500 as default. Within this limit and rounding variables, for almost all the tests performed, the process did achieve convergence. 

For the running example, the EFTs resulted from the whole process can be seen in `r fig_num("EFTs", display = "cite")`. In addition, the following code shows an example of the function call using the *BrickLayer* object produced in the previous "PCAs step" and setting the optimal number of clusters estimated with *clust_optim()*, a *nstart* value higher than 1 and the algorithm to be used.

```r
?EFT_clust

EFTs <- EFT_clust(obj2clust = pca_final_brick, 
                  n_clust = 20, 
                  nstart = 5,  
                  algorithm = "Hartigan-Wong",
                  filename = "EFTs.tif")

clust_eval <- EFTs[[2]]     # Evaluation of clustering performance
EFTs <- EFTs[[1]]           # RasterLayer object with the clusters (i.e. EFTs)

```
&nbsp;


![`r figEFTs`](`r EFTmap`)
&nbsp;



## Local Net Production Scaling

```{r echo=FALSE}
figLocNetProd <- fig_num(name = "LocNetProd", caption = "Local Net Primary Production Scaling (LNS): proportion of annual production (i.e. average of 5 years of Cyclic Fraction) over the local potential production (i.e. the 90-percentile within the Ecosystem Functional Type)")
LocNetProdMap <- paste0(path2saveTests, "/LocalNetProductivity_LSP.jpg")
```

The Local Net Primary Production Scaling (from now on, Local Net Scaling or LNS) method [@Prince_2009] is based on the use of multi-temporal satellite data to calculate the difference between the potential and actual NPP for each pixel in homogeneous land areas. It will be considered potential productivity that productivity which would have been without the influence of human factors, and it is estimated as the maximum value of productivity within each EFT [@Prince_2009, and references therein]. The current land production related to the local potential reflects the current level of productivity efficiency and, therefore, it is useful for the delineation of a productivity status map [@Ivits_report_2013]. 

Cyclic Fraction, or the summed NDVI over the growing season, is widely used as a proxy for the estimation of the current land productivity [@Fensholt_2013], as it incorporates both natural and anthropogenic factors which define the inter-annual variability of land production. Therefore, it represents that part of the standing biomass which is potentially appropriated to be used by humans and the environment [@Ivits_report_2013].  

The function *LNScaling()* is implemented in *LPDynR* to calculate the LNS. In the case study, the Cyclic Fraction derived from *Phenolo* for the period between 2008 and 2012 was passed to the function. This period coincides with the last five years of the time series used for the generation of the Long Term Change Map. Together with the productivity variable, the EFTs calculated previously are also passed to the function, and the potential productivity within each EFT is calculated. However, instead of the maximum value within each cluster, its 90-percentile is established as the final potential, given that values higher than this threshold can be considered as outliers. Finally, the LNS per pixel is calculated as the proportion of its annual production (i.e. the average of 5 years Cyclic Fraction) over the potential production within its EFT (i.e. the 90-percentile). The result for the case study is represented in `r fig_num("LocNetProd", display = "cite")`, and the following lines of code show an example on how to call the function.


```r
?LNScaling

LNScal <- LNScaling(EFTs = EFTs,   # RasterLayer with the EFTs
                    ProdVar = si,  # Productivity variable (time series; last 5 years will be averaged)
                    cores2use = 3,
                    filename = "LNScal.tif")
```
&nbsp;

![`r figLocNetProd`](`r LocNetProdMap`)


For the calculation of the final LPD indicator (i.e. Combined Assessment), these levels of local productivity will be aggregated into two categories: (1) pixels with less than 50% of the highest annual local production (within the EFT) and (2) pixels with more or equal to 50% of annual local production.



# Combined Assessment of Land Productivity
`r # # Long Term Change Map + Current Status Map of Land Productivity`
```{r echo=FALSE}
#LookUpCombAss_categs <- "'d', Declining Land-Productivity; 'ew', Early signs of decline of #L-P; 'nf', Stable but stressed L-P; 'pf', Stable, not stressed L-P; 'i', Increaseing L-P; #'si', Strong increase of L-P"
LookUpCombAss_categs <- "(1) d-Declining land-productivity, (2) ew-Early signs of decline of land productivity, (3) nf-Stable but stressed land productivity, (4) pf-Stable and not stressed land productivity and (5) i-Increaseing land productivity"
LookUpCombAss_categs_short <- "(1) d-Declining, (2) ew-Early signs of decline, (3) nf-Stable but stressed, (4) pf-Stable and not stressed and (5) i-Increasing"

figCombAssess <- fig_num(name = "figCombAss", caption = paste0("Land Productivity Dynamics indicator final map. Combined assessment of the Long Term Change Map and the Current Status Map of Land Productivity, based on Standing Biomass and Cyclic Fraction variables, respectively. Both variables are derived from time series of Earth Observation imagery using *Phenolo*. ", LookUpCombAss_categs))
LPD_CombinedAssessment <- paste0(path2saveTests, "/LPD_CombinedAssessment.jpg")


tabLookUpCombAss <- table_num(name = "tabLookUpCombAss", caption = paste0("Lookup table for the combination of the two branches assessment (i.e. Long Term Change Map of standing biomass and Current Status Map of Land Productivity of cyclic fraction) to derive the Land Productivity Dynamics categories (i.e. ", LookUpCombAss_categs, ")"))

LookUpCombAss <- as.data.frame(matrix(nrow = 22, ncol = 5,
                                      c(rep("st1", 9), rep("st2", 3), rep("st3", 3), rep("st4", 7),
                                        rep("lo", 3), rep("me", 3), rep("hi", 3), "lo", "me", "hi", "lo", "me", "hi", rep("lo", 3), rep("me", 3), "hi",
                                        rep(c(0, 1, 2), 3), rep(0, 6), rep(c(0, 1, 2), 2), 0,
                                        rep("d", 6), "ew", rep("d", 2), rep("nf", 3), rep("pf", 5), "i", "pf", rep("i", 3),
                                        "ew", "ew", "d", "ew", "ew", "d", "nf", "ew", "ew", rep("nf", 3), rep("pf", 3), "i", "i", "i", "i", "i", "i", "i")))
LookUpCombAss <- rbind(as.data.frame(matrix(c(rep("", 3), "< 50%", ">= 50%"), nrow = 1, ncol = 5)), LookUpCombAss)
LookUpCombAss <- rbind(as.data.frame(matrix(c("Steadiness I.", "Baseline L.", "State Change", "", "Local Sc."), nrow = 1, ncol = 5)), LookUpCombAss)
#names(LookUpCombAss) <- c("Steadiness I.", "Baseline L.", "State Change < 50%", "Local Sc.  >= 50%", "Local Sc.")
names(LookUpCombAss) <- c("Steadiness I.", "Baseline L.", "State Change", "Local Sc.", "Local Sc.")
```


The Land Productivity Dynamics indicator, as shown in see the flowchart of the process for its derivation in `r fig_num("f0", display = "cite")`, is based on the combination of two main sources of information: a map of the tendency, positive or negative, of the level of land productivity along the time series and another map capturing the current level of productivity of each pixel relative to the maximum productivity in a homogeneous land area. As seen above in this document, both branches to calculate the indicator are qualitative methods. Therefore, the final LPD indicator is also a qualitative measure with 5 possible values or categories after the reclassification of each pixel as shown in `r table_num("tabLookUpCombAss", display = "cite")`. Such categories are `r LookUpCombAss_categs_short` land productivity.


`r table_num("tabLookUpCombAss", display = "full")`
```{r echo=FALSE}
#pander(splittable(LookUpCombAss, 2))
#emphasize.strong.cells(which(LookUpCombAss$`Local Scaling < 50%` %in% c("d", "ew", "nf", "pf")))
emphasize.strong.cells(which(LookUpCombAss == "d" | 
                             LookUpCombAss == "ew" |
                             LookUpCombAss == "nf" |
                             LookUpCombAss == "pf" |
                             LookUpCombAss == "i", arr.ind = TRUE))
names(LookUpCombAss) <- NULL
pander(LookUpCombAss)

```
&nbsp;


In the case study presented in this document, the Land Productivity Dynamics indicator final map (`r fig_num("figCombAss", display = "cite")`) is the result of the combined assessment of the Long Term Change Map (`r fig_num("figLngTrm_change", display = "cite")`), based on the Standing Biomass, and the Current Status Map of Land Productivity (`r fig_num("LocNetProd", display = "cite")`), based on the Cyclic Fraction and derived through the Local Net Scaling approach.

The function to run the combined assessment to calculate the LPD indicator is *LPD_CombAssess()* and the following code shows an example of how to call it.

```r
?LPD_CombAssess

LPD_finalMap <- LPD_CombAssess(LandProd_change = "Long_Term_Change_Map", 
                               LandProd_current =  "LNScal",
                               filename = "LPD_finalMap.tif")
plot(LPD_finalMap)
```
&nbsp;


![`r figCombAssess`](`r LPD_CombinedAssessment`)
&nbsp;



## Alternative method for the LPD indicator


```{r echo = FALSE}

tabLookUpCombAss2 <- table_num(name = "tabLookUpCombAss", caption = paste0("Lookup table for the reclassification of the Long Term Change Map into the Land Productivity Dynamics categories (i.e. ", LookUpCombAss_categs, ")"))

LookUpCombAss2 <- as.data.frame(matrix(nrow = 22, ncol = 4,
                                      c(rep("st1", 9), rep("st2", 3), rep("st3", 3), rep("st4", 7),
                                        rep("lo", 3), rep("me", 3), rep("hi", 3), "lo", "me", "hi", "lo", "me", "hi", rep("lo", 3), rep("me", 3), "hi",
                                        rep(c(0, 1, 2), 3), rep(0, 6), rep(c(0, 1, 2), 2), 0,
                                        rep("d", 6), "ew", rep("d", 2), rep("nf", 3), rep("pf", 5), "i", "pf", rep("i", 3))))
LookUpCombAss2 <- rbind(as.data.frame(matrix(c("Steadiness I.", "Baseline L.", "State Change", "LPD class"), nrow = 1, ncol = 4)), LookUpCombAss2)
names(LookUpCombAss2) <- c("Steadiness I.", "Baseline L.", "State Change", "LPD class")
```


Although it has been shown previously the importance of including the Current Status Map in the production of the LPD indicator, the user might want to derive it only based on the tendency map (i.e. Long Term Change Map). The function *LPD_CombAssess()* has the potentiallity to do it by passing the argument *LandProd_current = NULL*. By doing so, the function reclassifies the Long Term Change Map into the same 5 categories of the LPD indicator descrived above, as shown in `r table_num("tabLookUpCombAss2", display = "cite")`.

`r table_num("tabLookUpCombAss2", display = "full")`
```{r echo=FALSE}
emphasize.strong.cells(which(LookUpCombAss2 == "d" | 
                             LookUpCombAss2 == "ew" |
                             LookUpCombAss2 == "nf" |
                             LookUpCombAss2 == "pf" |
                             LookUpCombAss2 == "i", arr.ind = TRUE))
names(LookUpCombAss2) <- NULL
pander(LookUpCombAss2)

```
&nbsp;


**Aquí falta el mapa comparatiu i les explicacions!!!**
comp_LPD_Methods_CombAssess.jpg






# Conclusions

As stated by the Intergovernmental Science-Policy Platform on Biodiversity and Ecosystem Services (IPBES), land degradation leads to a loss of biodiversity and a reduction of ecosystem functions and delivered services all over the world. Therefore, combating land degradation and restoring degraded lands has become an urgent priority in order to protect all life on Earth as well as to ensure human well-being [@IPBES_2018]. 

According to the flowchart presented at the beginning of this document (`r fig_num("f0", display = "cite")`), the Land Productivity Dynamics indicator (LPD) is derived from several phenological and productivity variables, in turn, obtained from time series of earth observation imagery.


# References

