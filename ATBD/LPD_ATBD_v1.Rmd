---
title: "LAND PRODUCTIVITY DYNAMICS"
author: ""
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output: 
  word_document:
    reference_docx: LPD_MS_styles.docx
    toc: true #table of content true
    toc_depth: 3  #up to three depths of headings (specified by #, ## and ###)
    #number_sections: true  #number sections at each table header
    #theme: united  #options for theme
    #highlight: tango  #syntax highlighting style
    #css: my.css   #custom css, should be in same folder
bibliography: lpd_biblio.bib
#csl: methods-in-ecology-and-evolution.csl
#always_allow_html: yes

---


```{r setup, include = FALSE, results='asis'}
library(knitr)
library(pander)
library(captioner)
knitr::opts_chunk$set(echo = TRUE)

```

```{r include = FALSE}
if(Sys.info()[4] == "D01RI1700371"){
  source("E:\\rotllxa\\LPD\\LPD/00_settings.R")
}else if(Sys.info()[4] == "h05-wad.ies.jrc.it"){
  source("/home/rotllxa/LPD/LPD/00_settings.R")
}else if(Sys.info()[4] == "MacBook-MacBook-Pro-de-Xavier.local"){
  source("/Users/xavi_rp/Documents/D6_LPD/LPD/00_settings.R")
}

table_num <- captioner::captioner(prefix = "Table")
fig_num <- captioner::captioner(prefix = "Figure")
#ts <- 0
```



# Abstract

[@ivits_assessing_2016]




# Introduction (Background)

```{r echo=FALSE}

tb1 <- table_num(name = "t1", caption = "bla bla bla")
 
```
 
`r table_num("t1", display = "cite")`

a) general introduction
UNCCD, SDG 15.3, Indicator

[@Prince_2009]: Techniques for measurement of Net Primary Production (NPP) using Earth-observing satellite data were first developed in the mid 1980s


b) Land Productivity Dynamics Map: 

Include here a diagram of the whole process

```{r echo=FALSE}
fig0 <- fig_num(name = "f0", caption = "Flowchart of the process to calculate the Land-Productivity Dynamics indicator")
grph02 <- paste0(path2tempResults, "/graph02.png")
```





Phenological variables (Phenolo or others), Net Primary Productivity, etc (include here Eva's graph: Figure 3: Schematic representation of the main phenological and productivity variables calculated by Phenolo (reprint from Ivits et al., 2013a).)

Land Productivity Dynamics Map (`r fig_num("f0", display = "cite")`)= Long Term Change Map + Current Status Map of Land-Productivity


![`r fig0`](`r grph02`)


Qualitative indicator...


A case study is presented in this document in order to illustrate the methodology to calculate the LPD indicator. It is used a data set of `r length(vrbls_lst)` phenological and productivity variables, at global level and 1km of spatial resolution, obtained with *Phenolo*, a software developed at the EC-Joint Research Centre. *Phenolo* uses time series from different satellite sensors (NOAA, SPOT, etc.) and products (NDVI, fAPAR, etc.) to derive several ecosystem dynamism indicators [@ivits_ecosystem_2013]. In this case, the *Phenolo* products used are `r paste0(vrbls_lst_names, collapse = ", ")` and they have been derived from SPOT Vegetation NDVI of the period 1999-2012.




# Phenolo
Should this part be removed?? I think so...
If not, I keep it for Lorenzo to fill it.



# Long-Term Change Map of Land-Productivity



## Steadiness Index for Standing Biomass

```{r echo=FALSE}
fig1 <- fig_num(name = "f1", caption = "ble ble ble")
slp_rstr <- paste0(path2saveTests, "/slope_rstr.jpg")
```


`r fig_num("f1", display = "cite")`

![`r fig1`](`r slp_rstr`)






## Combining Steadiness Index with Baseline Levels of Standing Biomass


## Standing Biomass State Change


## Land-Productivity Long Term Change Map

```{r echo=FALSE}
figLandProd_change <- fig_num(name = "figLandProd_change", caption = "blu blu blu")
LandProd_change <- paste0(path2saveTests, "/LandProd_change.jpg")
```


![`r figLandProd_change`](`r LandProd_change`)


# Current Status Map of Land-Productivity




## Ecosystem Functional Types (EFTs)
```{r echo=FALSE}
figMulticoll <- fig_num(name = "Multicoll", caption = "Dendrogram of groups of correlated variables. Multicollinearity cutoff set to r > |0.7|")
Multicoll_plot <- paste0(path2tempResults, "/vars_collinearity.jpg")

figEFTs <- fig_num(name = "EFTs", caption = "Ecosystem Functional Types (EFTs) derived from phenological and productivity variables using the k-means clustering method")
EFTmap <- paste0(path2saveTests, "/clusters_EFTs.jpg")
```

What is EFTs and Why are they needed?

The methodology to prepare the data to be clustered is a three steps process: (1) the `r length(vrbls_lst)` phenological and productivity-relatied variables are checked against multicollinearity, removing those highly correlated (|r| > 0.7); (2) a first PCA ("screening PCA") with the less-correlated variables is run in order to know the optimal number of variables (PC axes) to be used in a subsequent PCA, as well as the phenological variable most associated to that PC; and (3) a final PCA is run with the results of the step 2. After that, the clustering process is made using the rotated components of the final PCA instead of with the phenological variables because the former are normalized with zero mean and 1 SD, which is statistically meaningful for iterative clustering of pixels using minimum distance techniques [@Ivits_report_2013].

In order to check for multicollinearity among the variables, their average is calculated taking adventadge of the parallelization tools (i.e. ```library(parallel)```). Then, the process is run using the function ```removeCollinearity()``` from the package ```virtualspecies```. This function allows the user to set the minimum Pearson's correlation absolute value, which in this case is established to be 0.7 as default. It is also allowed to use a subset of random points of the data set to calculate the correlation. The default has been set to 1000000 to speed up the process. Finally, the user can also choose to randomly select one of the variables of each group o correlation. The main part of the code is as follows:
&nbsp;
```{r include = TRUE, eval = FALSE, size = 'normalsize'}
vrbles_NoC <- virtualspecies::removeCollinearity(stack_rstrs_avg, multicollinearity.cutoff = 0.70, select.variables = TRUE, sample.points = TRUE, nb.points = 1000000, plot = TRUE)
dev.copy(jpeg, paste0(path2tempResults, "/vars_collinearity.jpg"))    
dev.off() 
```
&nbsp;

`r fig_num("Multicoll", display = "cite")` shows a dendrogram to visualize the groups of intercorrelated variables in the present case study.

![`r figMulticoll`](`r Multicoll_plot`)





## Local Net Production Scaling

```{r echo=FALSE}
figLocNetProd <- fig_num(name = "LocNetProd", caption = "Local Net Primary Production Scaling (LNS): proportion of annual production (i.e. average of 5 years of Cyclic Fraction) over the local potential production (i.e. the 90-percentile within the Ecosystem Functional Type)")
LocNetProd <- paste0(path2saveTests, "/LocalNetProductivity_LSP.jpg")
```

The Local Net Primary Production Scaling (from now on, Local Net Scaling or LNS) method [@Prince_2009] is based on the use of multi-temporal satellite data to calculate the difference between the potential and actual NPP for each pixel in homogeneous land areas. It will be considered potential productivity that productivity which would have been were it not for human factors, and it is estimated as the maximum value of productivity within each EFT [@Prince_2009, and references therein]. The current land production related to the local potential reflects the current level of productivity efficiency and, therefore, it is useful for the delineation of a productivity status map [@Ivits_report_2013]. 

Cyclic Fraction, or the summed NDVI over the growing season, is widely used as a proxy for the estimation of the current land productivity [@Fensholt_2013], as it incorporates both natural and anthropogenic factors which define the inter-annual variability of land production. Therefore, it represents that part of the Standing Biomass which is potentially appropriated to be used by humans and the environment [@Ivits_report_2013].  

In the case study, the Cyclic Fraction was derived from *Phenolo* for the period between 2008 and 2012, and each pixel subsequently averaged. That period coincides with the last five years of the time series used for the generation of the Long Term Change Map. The computation process for averaging was done again using parallelization, as seen in the following code:
&nbsp;
```{r include = TRUE, eval = FALSE, size = 'normalsize'}
beginCluster(cors2use)   # it uses 'cors2use' cores for parallelizing
yrs <- (nlayers(CycleFraction_rstr) - 4):nlayers(CycleFraction_rstr)
CycleFraction_rstr_average <- clusterR(CycleFraction_rstr, calc, args = list(fun = mean_years_function), export = "yrs")
endCluster()
```
&nbsp;

Then, the potential productivity within each EFT was calculated. However, instead of the maximum value, its 90 percentile was established as the final potential, given that values higher than this threshold were considered as outliers. 

Finally, the Local Net Scaling per pixel was calculated as the proportion of its annual production (i.e. the average of 5 years Cyclic Fraction) over the potential production within its EFT (i.e. the 90 percentile). The result, shown in `r fig_num("LocNetProd", display = "cite")`, was expressed in percentage and was computed as follows: 
&nbsp;
```{r include = TRUE, eval = FALSE, size = 'normalsize'}
CycleFraction_average_df$LSP <- round(((CycleFraction_average_df$CyclicFraction / CycleFraction_average_df$CyclicFraction_90perc) * 100), 1)
```
&nbsp;

![`r figLocNetProd`](`r LocNetProd`)


For the calculation of the final LPD indicator, these levels of local productivity were aggregated into two categories, i.e, pixels with less than 50% of the highest annual local production (within the EFT) and pixels with more or equal to 50% of annual local production.



# Combined Assessment of Land-Productivity
`r # # Long Term Change Map + Current Status Map of Land-Productivity`
```{r echo=FALSE}
figCombAss <- fig_num(name = "figCombAss", caption = "Land-Productivity Dynamics indicator final map. Combined assessment of the Long-Term Channge Map of standing biomass and the Current Status Map of Land-Productivity based on the cyclic fraction")
LPD_CombinedAssessment <- paste0(path2saveTests, "/LPD_CombinedAssessment.jpg")

LookUpCombAss_categs <- "'d', Declining L-P; 'ew', Early signs of decline L-P; 'nf', Stable but stressed L-P; 'pf', Stable, not stressed L-P; 'i', Increase L-P; 'si', Strong increase of L-P"

tabLookUpCombAss <- table_num(name = "tabLookUpCombAss", caption = paste0("Lookup table for the combination of the two branches assessment (i.e. Long-Term Channge Map of standing biomass and Current Status Map of Land-Productivity of cyclic fraction) to derive the Land-Productivity Dynamics categories (i.e. ", LookUpCombAss_categs, ")"))

LookUpCombAss <- as.data.frame(matrix(nrow = 22, ncol = 5,
                                      c(rep("st1", 9), rep("st2", 3), rep("st3", 3), rep("st4", 7),
                                        rep("lo", 3), rep("me", 3), rep("hi", 3), "lo", "me", "hi", "lo", "me", "hi", rep("lo", 3), rep("me", 3), "hi",
                                        rep(c(0, 1, 2), 3), rep(0, 6), rep(c(0, 1, 2), 2), 0,
                                        rep("d", 6), "ew", rep("d", 2), rep("nf", 3), rep("pf", 5), "i", "pf", rep("i", 3),
                                        "ew", "ew", "d", "ew", "ew", "d", "nf", "ew", "ew", rep("nf", 3), rep("pf", 3), "i", "i", "si", "i", "i", "si", "si")))
LookUpCombAss <- rbind(as.data.frame(matrix(c(rep("", 3), "< 50%", ">= 50%"), nrow = 1, ncol = 5)), LookUpCombAss)
LookUpCombAss <- rbind(as.data.frame(matrix(c("Steadiness I.", "Baseline L.", "State Change", "", "Local Sc."), nrow = 1, ncol = 5)), LookUpCombAss)
#names(LookUpCombAss) <- c("Steadiness I.", "Baseline L.", "State Change < 50%", "Local Sc.  >= 50%", "Local Sc.")
names(LookUpCombAss) <- c("Steadiness I.", "Baseline L.", "State Change", "Local Sc.", "Local Sc.")
```


The Land-Productivity Dynamics indicator final map (`r fig_num("figCombAss", display = "cite")`) is the result of the combined assessment of the Long-Term Change Map (`r fig_num("figLandProd_change", display = "cite")`), based on the standing biomass, and the Current Status Map of Land-Productivity (`r fig_num("LocNetProd", display = "cite")`), based on the cyclic fraction and derived through the Local Net Scaling approach. See the flowchart of the process for the derivation of the indicator in `r fig_num("f0", display = "cite")`.

As seen above in this document, both branches to calculate the indicator are qualitative methods. Therefore, the final LPD indicator is also a qualitative measure with 6 possible values or categories after the reclassification of each pixel as shown in the lookup table (`r table_num("tabLookUpCombAss", display = "cite")`). Such categories are `r LookUpCombAss_categs`.


`r table_num("tabLookUpCombAss", display = "full")`
```{r echo=FALSE}
#pander(splittable(LookUpCombAss, 2))
#emphasize.strong.cells(which(LookUpCombAss$`Local Scaling < 50%` %in% c("d", "ew", "nf", "pf")))
emphasize.strong.cells(which(LookUpCombAss == "d" | 
                             LookUpCombAss == "ew" |
                             LookUpCombAss == "nf" |
                             LookUpCombAss == "pf" |
                             LookUpCombAss == "i" |
                             LookUpCombAss == "si", arr.ind = TRUE))
names(LookUpCombAss) <- NULL
pander(LookUpCombAss)



```
&nbsp;

![`r figCombAss`](`r LPD_CombinedAssessment`)



# Conclusions

According to the flowchart presented at the beginning of this document (`r fig_num("f0", display = "cite")`), the Land-Productivity Dynamics indicator (LPD) is derived from several phenological and productivity variables, in turn, obtained from time series of earth observation imagery.


# References

